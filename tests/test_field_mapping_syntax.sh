#!/bin/bash
# 测试字段映射和常量值语法

echo "=== 测试字段映射和常量值语法 ==="
echo ""

# 切换到订单表
echo "1. 切换到订单表..."
t use 订单表 > /dev/null 2>&1
echo "✅ 已切换到订单表"
echo ""

# 测试1: 常量值语法
echo "2. 测试常量值语法（目标字段=常量值）"
echo "   命令: echo 'recTest001 订单号=ORD001' | t insert 客户名称=新客户 状态=已完成"
echo "recTest001 订单号=ORD001" | t insert 客户名称=新客户 状态=已完成 2>&1 | grep -E "(使用手动映射模式|常量值)" | head -2
echo "   说明: 无论管道记录中有什么，都使用常量值'新客户'和'已完成'"
echo ""

# 测试2: 字段映射语法（@前缀）
echo "3. 测试字段映射语法（@字段名）"
echo "   命令: echo 'recTest002 订单号=ORD002 客户名称=张三' | t insert 新订单=@订单号 原客户=@客户名称"
echo "recTest002 订单号=ORD002 客户名称=张三" | t insert 新订单=@订单号 原客户=@客户名称 2>&1 | grep -E "(使用手动映射模式|字段映射)" | head -2
echo "   说明: 从管道记录中获取'订单号'和'客户名称'字段的值"
echo ""

# 测试3: 字段映射语法（$前缀）
echo "4. 测试字段映射语法（\$字段名）"
echo "   命令: echo 'recTest003 订单号=ORD003' | t insert 新订单=\$订单号"
echo "recTest003 订单号=ORD003" | t insert 新订单=\$订单号 2>&1 | grep -E "(使用手动映射模式|字段映射)" | head -2
echo "   说明: \$前缀和@前缀功能相同，都表示字段映射"
echo ""

# 测试4: 混合使用
echo "5. 测试混合使用（字段映射 + 常量值）"
echo "   命令: echo 'recTest004 订单号=ORD004 客户名称=李四' | t insert 新订单=ORD999 原客户=@客户名称 状态=已完成"
echo "recTest004 订单号=ORD004 客户名称=李四" | t insert 新订单=ORD999 原客户=@客户名称 状态=已完成 2>&1 | grep -E "(使用手动映射模式|字段映射|常量值)" | head -3
echo "   说明: '新订单'和'状态'使用常量值，'原客户'使用字段映射"
echo ""

# 测试5: 对比测试
echo "6. 对比测试：常量值 vs 字段映射"
echo "   管道记录: recTest005 客户名称=张三"
echo ""
echo "   常量值语法:"
echo "   echo 'recTest005 客户名称=张三' | t insert 客户名称=新客户"
echo "   结果: 使用常量值'新客户'（忽略管道记录中的'张三'）"
echo ""
echo "   字段映射语法:"
echo "   echo 'recTest005 客户名称=张三' | t insert 客户名称=@客户名称"
echo "   结果: 使用管道记录中的值'张三'"
echo ""

echo "=== 语法规则总结 ==="
echo ""
echo "✅ 常量值语法: 目标字段=常量值"
echo "   - 直接使用指定的常量值"
echo "   - 即使管道记录中有同名字段，也使用常量值"
echo ""
echo "✅ 字段映射语法: 目标字段=@源字段 或 目标字段=\$源字段"
echo "   - 从管道记录中获取指定字段的值"
echo "   - 如果管道记录中不存在该字段，会跳过该字段"
echo ""
echo "✅ 混合使用: 可以同时使用字段映射和常量值"
echo "   - 例如: t insert 新订单=ORD999 原客户=@客户名称 状态=已完成"

