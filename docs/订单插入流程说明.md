# Teable CLI 插入订单流程说明

## 完整流程

### 1. 准备工作
- 确保已配置正确的连接信息（Base URL、Token、Base ID）
- 切换到目标表格：`t use 订单表`

### 2. 检查并准备关联数据（按依赖顺序）

**重要原则**: 先检查基础表中是否已有数据，有则直接使用，无则创建。

#### 步骤1: 检查并创建客户
```bash
# 1. 检查客户表中是否已有目标客户
t use "客户表"
t show 客户名称like巴斯夫  # 查询是否已有"巴斯夫"客户

# 2. 如果没有找到目标客户，则创建
# 例如：如果查询结果为空，则创建
t insert "客户名称=巴斯夫"

# 或者先查看所有客户列表（如果不知道具体名称）
# t show limit=20  # 查看前20条客户记录
```
**注意事项**:
- 先查看现有客户，避免重复创建
- 如果客户已存在，直接使用客户名称或记录ID即可
- 记录创建成功后会返回记录ID，可以保存备用

#### 步骤2: 检查并创建地址
```bash
# 1. 检查地址库表中是否已有目标地址
t use "地址库表"
t show 任务like巴斯夫  # 查询是否已有巴斯夫相关的地址

# 2. 如果没有找到目标地址，则创建
# 例如：如果没有"巴斯夫上海仓库"，则创建
t insert "任务=巴斯夫上海仓库" "详细地址=上海市浦东新区张江高科技园区" "地址类型=发货地址" "关联客户=巴斯夫"
t insert "任务=巴斯夫北京收货点" "详细地址=北京市海淀区中关村大街" "地址类型=收货地址" "关联客户=巴斯夫"

# 或者先查看所有地址列表（如果不知道具体名称）
# t show limit=20  # 查看前20条地址记录
```
**注意事项**:
- 先查看现有地址，可以使用现有地址或创建新地址
- 地址类型必须使用正确的选项值（如：发货地址、收货地址）
- 关联客户字段会自动查找匹配的客户记录
- 如果找不到匹配记录，系统会提示是否创建新记录（命令行模式下会失败）

#### 步骤3: 检查并创建产品
```bash
# 1. 检查产品表中是否已有目标产品
t use "产品表"
t show 产品名称like塑料  # 查询是否已有"塑料"产品

# 2. 如果没有找到目标产品，则创建
# 例如：如果查询结果为空，则创建
t insert "产品名称=塑料" "产品分类=普通货物" "标准毛重=2" "标准净重=2"

# 或者先查看所有产品列表（如果不知道具体名称）
# t show limit=20  # 查看前20条产品记录
```
**注意事项**:
- 先查看现有产品，可以使用现有产品或创建新产品
- 产品分类必须使用下拉选项中的值（如：普通货物、危险品等）
- 重量单位需要确认（可能是吨、公斤等）

#### 步骤4: 创建货物明细
```bash
# 货物明细通常是每个订单特有的，一般需要创建
t use "货物明细表"
t insert "货物名称=塑料" "毛重=2" "关联产品=塑料"  # 使用产品名称或ID
```
**注意事项**:
- 货物明细通常是订单级别的数据，每个订单都需要创建
- 关联产品字段是必填的，可以使用产品记录ID或产品名称
- 如果使用名称，系统会自动查找匹配的产品记录

### 3. 创建订单
```bash
t use "订单表"
t insert "委托时间=2025-11-14" "要求到达时间=2025-11-16" "货物类型=普通货物" "运输方式=公路运输" "订单状态=待接单" "关联客户=巴斯夫" "提货地址=巴斯夫上海仓库" "送货地址=巴斯夫北京收货点" "货物明细表=recZK7ruLDOTtIRoJ0z"
```

## 关键注意事项

### 1. 字段类型和选项值
- **singleSelect字段**: 必须使用预定义的选项值，不能随意填写
  - 例如：`运输方式` 必须使用 "公路运输"、"铁路运输" 等，不能使用 "公路"
  - 查看选项值：可以通过查看表格结构或查看现有记录来确定可用选项

### 2. 必填字段验证
- 订单表有以下必填字段：
  - 委托时间
  - 要求到达时间
  - 关联客户
  - 提货地址
  - 送货地址
  - 货物明细表
- 如果必填字段未填写，插入会失败并返回400错误

### 3. 关联字段处理
- **关联字段（link类型）**: 
  - 支持使用记录ID直接关联：`关联客户=recBxWmqXtTa6ZuCyvX`
  - 支持使用名称模糊匹配：`关联客户=巴斯夫`
  - 如果找不到匹配记录，系统会提示是否创建新记录（交互式模式）
  - 命令行模式下，如果找不到匹配记录会失败

### 4. 日期格式
- 日期字段使用标准格式：`YYYY-MM-DD`
- 例如：`2025-11-14`、`2025-11-16`

### 5. 数据依赖关系
创建订单前需要确保以下关联数据存在（检查现有数据，没有则创建）：
```
订单
├── 关联客户 (检查客户表，没有则创建)
├── 提货地址 (检查地址库表，没有则创建，需关联客户)
├── 送货地址 (检查地址库表，没有则创建，需关联客户)
└── 货物明细表 (通常需要创建，每个订单不同)
    └── 关联产品 (检查产品表，没有则创建)
```

**数据检查策略**:
- **客户表**: 基础数据，通常已存在，先检查再决定是否创建
- **产品表**: 基础数据，通常已存在，先检查再决定是否创建
- **地址库表**: 基础数据，可能已存在，先检查再决定是否创建
- **货物明细表**: 订单级数据，通常需要为每个订单创建

### 6. 字段过滤机制
- 系统会自动跳过以下字段：
  - 公式字段（formula）
  - 引用字段（lookup）
  - 系统字段（id、createdTime、updatedTime等）
- 这些字段不需要手动填写，系统会自动处理

### 7. 错误处理
常见错误及解决方法：

**400错误 - 字段验证失败**:
- 检查必填字段是否都已填写
- 检查选项字段的值是否正确
- 检查日期格式是否正确

**404错误 - 关联记录未找到**:
- 确认关联的记录已创建
- 检查关联字段的值是否正确（名称或ID）
- 尝试使用记录ID而不是名称

**500错误 - 服务器错误**:
- 可能是表格结构问题
- 检查数据格式是否正确
- 尝试简化数据，逐步添加字段

## 最佳实践

1. **先检查再创建**: 
   - 基础表（客户表、产品表、地址库表）先查看现有数据
   - 如果已有可用数据，直接使用；如果没有，再创建
   - 避免重复创建相同的基础数据

2. **按顺序准备**: 先准备基础数据（客户、产品），再准备关联数据（地址、货物明细），最后创建订单

3. **使用记录ID**: 对于关联字段，如果知道记录ID，直接使用ID更可靠

4. **验证数据**: 创建后使用 `t show` 命令查看数据，确认创建成功

5. **交互式模式**: 对于复杂的关联字段，使用交互式模式（`t insert` 不带参数）可以更好地处理关联记录查找

6. **查看字段结构**: 不确定字段类型或选项值时，先查看表格结构：
   ```bash
   python3 -c "from teable_api_client import TeableClient; from config import Config; ..."
   ```

7. **查询现有数据**: 使用 `t show` 命令查看现有记录，确定是否已有可用数据：
   ```bash
   t use "客户表"
   t show limit=50  # 查看前50条客户记录
   t show 客户名称like巴斯夫  # 模糊查询特定客户
   ```

## 完整示例命令序列

```bash
# ===== 步骤1: 检查并准备客户 =====
t use "客户表"
t show 客户名称like巴斯夫  # 查询是否已有"巴斯夫"客户
# 如果查询结果为空，则创建：
t insert "客户名称=巴斯夫"
# 如果有，直接使用客户名称即可

# ===== 步骤2: 检查并准备地址 =====
t use "地址库表"
t show 任务like巴斯夫  # 查询是否已有巴斯夫相关的地址
# 如果没有"巴斯夫上海仓库"，则创建：
t insert "任务=巴斯夫上海仓库" "详细地址=上海市浦东新区张江高科技园区" "地址类型=发货地址" "关联客户=巴斯夫"
# 如果没有"巴斯夫北京收货点"，则创建：
t insert "任务=巴斯夫北京收货点" "详细地址=北京市海淀区中关村大街" "地址类型=收货地址" "关联客户=巴斯夫"
# 如果有合适的地址，直接使用地址名称即可

# ===== 步骤3: 检查并准备产品 =====
t use "产品表"
t show 产品名称like塑料  # 查询是否已有"塑料"产品
# 如果查询结果为空，则创建：
t insert "产品名称=塑料" "产品分类=普通货物" "标准毛重=2" "标准净重=2"
# 如果有，直接使用产品名称即可

# ===== 步骤4: 创建货物明细（通常需要创建）=====
t use "货物明细表"
t insert "货物名称=塑料" "毛重=2" "关联产品=塑料"  # 使用产品名称或ID

# ===== 步骤5: 创建订单 =====
t use "订单表"
t insert "委托时间=2025-11-14" "要求到达时间=2025-11-16" "货物类型=普通货物" "运输方式=公路运输" "订单状态=待接单" "关联客户=巴斯夫" "提货地址=巴斯夫上海仓库" "送货地址=巴斯夫北京收货点" "货物明细表=塑料"
```

**快速检查命令**:
```bash
# 快速检查各基础表是否有数据
t use "客户表" && t show limit=5
t use "产品表" && t show limit=5
t use "地址库表" && t show limit=5

# 使用模糊查询查找特定数据
t use "客户表" && t show 客户名称like巴斯夫
t use "产品表" && t show 产品名称like塑料
t use "地址库表" && t show 任务like巴斯夫
```

## 总结

插入订单是一个多步骤的过程，需要：
1. **先检查再创建**: 基础表（客户、产品、地址）先查看现有数据，有则使用，无则创建
2. 理解数据依赖关系
3. 按正确顺序准备关联数据
4. 注意字段类型和选项值
5. 确保必填字段都已填写
6. 正确处理关联字段的匹配

**核心原则**: 
- 基础数据（客户、产品、地址）通常已存在，先检查再决定是否创建
- 订单级数据（货物明细）通常需要为每个订单创建
- 使用 `t show` 命令查看现有数据，避免重复创建

通过遵循以上流程和注意事项，可以高效地创建完整的订单记录。

