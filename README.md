# Teable CLI

一个用于操作 Teable 数据库的命令行工具。

## 功能特性

- **表格管理**: 创建、查看、切换表格
- **记录操作**: 插入、更新、删除、查询记录
- **关联字段支持**: 智能处理关联字段，支持多种匹配方式
- **交互式操作**: 友好的交互式界面
- **灵活查询**: 支持过滤、排序、分页等高级查询

## 安装

```bash
pip install -e .
```

## 配置

首次使用需要配置连接信息：

```bash
t config
```

按提示输入：
- API 基础 URL (如: https://app.teable.cn)
- 认证令牌 (在 Teable 设置中获取)
- 数据库 ID

## 使用方法

### 基本命令

```bash
# 查看帮助
t --help

# 列出所有表格
t tables

# 切换到指定表格
t use <表格名称>

# 显示当前表格数据
t show [选项]

# 插入记录
t insert [字段1=值1 字段2=值2 ...]

# 更新记录
t update <记录ID> [字段1=值1 字段2=值2 ...]

# 删除记录
t delete <记录ID1> [记录ID2 ...]
```

### 关联字段支持

CLI 现在支持关联字段的智能处理：

#### 插入关联记录

```bash
# 假设有"订单"表格，其中"客户"是关联字段
t insert 订单号=ORD001 客户=张三 金额=1000

# 支持多种匹配方式：
# 1. 记录ID: 客户=recXXXXXXXXXXXXXXXX
# 2. 显示字段值: 客户=张三  
# 3. 模糊匹配: 客户=张
```

#### 更新关联记录

```bash
# 更新订单的客户关联
t update recXXXXXXXXXXXXXXXX 客户=李四
```

#### 交互式选择

当关联字段有多个匹配结果时，CLI 会显示选择界面：

```
字段 '客户' 找到多个匹配记录:
  1. 张三 (ID: recXXXXXXXXXXXXXX01)
  2. 张三丰 (ID: recXXXXXXXXXXXXXX02)
  3. 张小明 (ID: recXXXXXXXXXXXXXX03)

请选择记录编号 (或输入0取消): 
```

### 高级查询

```bash
# 显示记录（支持分页、过滤、排序）
t show limit=50 order=创建时间:desc

# 过滤查询
t show 状态=已完成 金额>1000

# 模糊查询
t show 客户名称like张

# 组合查询
t show 状态=已完成 金额>1000 order=创建时间:desc limit=20
```

### 交互式操作

不带参数的插入和更新命令会进入交互式模式：

```bash
# 交互式插入记录
t insert

# 交互式更新记录
t update recXXXXXXXXXXXXXXXX
```

## 关联字段处理机制

### 智能匹配算法

1. **记录ID匹配**: 首先尝试将输入值作为记录ID进行精确匹配
2. **显示字段匹配**: 尝试匹配常见显示字段（name, title 等）
3. **模糊匹配**: 使用 contains 操作符进行模糊查询
4. **交互式选择**: 多个结果时让用户选择

### 支持的关联关系

- manyMany: 多对多
- manyOne: 多对一  
- oneMany: 一对多
- oneOne: 一对一

### 错误处理

- 未找到匹配记录时会显示警告并跳过该字段
- 用户取消选择时会跳过该字段
- 关联字段值为空时会跳过处理

## 示例场景

### 场景1：订单管理

假设有两个表格：
- 客户表：包含客户基本信息
- 订单表：包含订单信息，关联到客户表

```bash
# 1. 切换到订单表
t use 订单

# 2. 插入新订单，关联到客户
t insert 订单号=ORD2024001 客户=张三 产品=笔记本电脑 金额=8999

# 3. 如果"张三"有多个匹配，会显示选择界面
# 4. 更新订单客户
t update recXXXXXXXXXXXXXXXX 客户=李四
```

### 场景2：数据查询

```bash
# 查看最近完成的订单
t use 订单
t show 状态=已完成 order=完成时间:desc limit=10

# 查看特定客户的订单
t show 客户名称=张三 order=创建时间:desc
```

## 注意事项

1. **关联字段性能**: 大量数据时模糊匹配可能影响性能
2. **字段名称**: 确保使用正确的字段名称，区分大小写
3. **数据类型**: 关联字段最终存储的是记录ID
4. **权限**: 确保有权限访问关联的表格和记录

## 故障排除

### 常见问题

1. **找不到关联记录**
   - 检查外键表中是否存在匹配的数据
   - 尝试使用更精确的匹配条件
   - 确认有权限访问外键表

2. **关联字段更新失败**
   - 确认关联关系类型是否支持更新
   - 检查目标记录是否存在
   - 验证用户权限

3. **性能问题**
   - 尽量使用记录ID进行精确匹配
   - 避免在大量数据上使用模糊匹配

## 更新日志

### v1.1.0
- 新增关联字段支持
- 智能记录匹配算法
- 交互式选择界面
- 改进的错误处理

### v1.0.0
- 基础CRUD操作
- 表格管理功能
- 高级查询支持
- 交互式操作界面
