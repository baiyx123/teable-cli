# Teable CLI

一个用于操作 Teable 数据库的命令行工具。

## 功能特性

- **表格管理**: 创建、查看、切换表格
- **表格结构管理**: 创建表格、添加字段、查看表结构
- **记录操作**: 插入、更新、删除、查询记录
- **关联字段支持**: 智能处理关联字段，支持多种匹配方式
- **公式字段支持**: 创建和计算公式字段
- **交互式操作**: 友好的交互式界面
- **灵活查询**: 支持过滤、排序、分页等高级查询
- **管道流式操作**: 支持Linux管道，实现命令链式操作和流式数据处理

## 安装

```bash
pip install -e .
```

## 配置

首次使用需要配置连接信息：

```bash
t config
```

按提示输入：
- API 基础 URL (如: https://app.teable.cn)
- 认证令牌 (在 Teable 设置中获取)
- 数据库 ID

## 使用方法

### 基本命令

```bash
# 查看帮助
t --help

# 列出所有表格
t tables

# 切换到指定表格
t use <表格名称>

# 显示当前表格数据
t show [选项]

# 显示结果包含记录ID列（第一列），方便后续修改操作
t show

# 插入记录
t insert [字段1=值1 字段2=值2 ...]

# 更新记录
t update [表名] <记录ID> [字段1=值1 字段2=值2 ...]
t update [表名] 字段1=值1 字段2=值2 ... [where 条件字段1=值1 ...]

# 删除记录
t delete <记录ID1> [记录ID2 ...]

# 创建表格
t create <表名> [字段定义...]
t create <表名> --desc <描述> [字段定义...]

# 查看表格结构
t desc [表名]
t schema [表名]
t fields [表名]

# 修改表格结构（添加字段）
t alter add [表名] <字段名> <字段类型> [选项...]
t alter add [表名] <字段名> link <关联关系> <目标表名>
t alter add [表名] <字段名> lookup <关联字段名> <引用字段名>
t alter add [表名] <字段名> formula <表达式>

# 示例：指定表名添加字段
t alter add 订单表 未收金额 formula "{订单金额} - {已收金额}"
t alter add 订单表 客户名称 lookup 关联客户 客户名称

# 查看版本
t version
```

### 创建和管理表格

#### 创建表格

```bash
# 创建简单表
t create 测试表 姓名:singleLineText 年龄:number

# 创建带描述的表
t create 订单表 --desc "订单信息表" 订单号:singleLineText 金额:number

# 创建带选项的表
t create 状态表 状态名:singleLineText 类型:singleSelect:类型1,类型2

# 创建带关联字段的表（需要先有目标表）
t create 订单表 订单号:singleLineText 关联客户:link:manyOne:客户表

# 创建带公式字段的表
t create 订单明细表 单价:number 数量:number 总价:formula:{单价} * {数量}

# 创建带精度的数字字段（整数）
t create 订单表 订单号:singleLineText 数量:number:0

# 创建带精度的数字字段（2位小数）
t create 订单表 订单号:singleLineText 金额:number:2
```

**字段定义格式：**
- `<字段名>:<字段类型>` - 普通字段
- `<字段名>:number:<精度>` - 数字字段（精度为小数位数，0表示整数，默认精度为2）
- `<字段名>:link:<关联关系>:<目标表名>` - 关联字段
- `<字段名>:formula:<表达式>` - 公式字段（表达式使用 `{字段名}` 引用其他字段）

**支持的字段类型：**
- `singleLineText` - 单行文本
- `longText` - 长文本
- `number` - 数字
- `checkbox` - 复选框
- `singleSelect` - 单选（格式: `singleSelect:选项1,选项2`）
- `multipleSelect` - 多选（格式: `multipleSelect:选项1,选项2`）
- `date` - 日期
- `rating` - 评分
- `formula` - 公式字段
- `rollup` - 汇总
- `autoNumber` - 自动编号
- `link` - 关联字段
- `user` - 用户
- `attachment` - 附件

**关联关系类型：**
- `manyOne` - 多对一
- `oneMany` - 一对多
- `manyMany` - 多对多
- `oneOne` - 一对一

**公式字段说明：**
- 公式字段会在表创建后自动添加（因为需要引用其他字段的ID）
- 表达式使用 `{字段名}` 引用其他字段，会自动转换为字段ID
- 支持常见的数学运算和函数
- 表达式中的字段名会自动替换为对应的字段ID
- 支持引用autoNumber字段进行编号格式化（如：`{订单号} + 5000000000`）

#### 查看表格结构

```bash
# 查看当前表的结构
t desc

# 查看指定表的结构
t desc 订单表

# 使用别名
t schema 订单表
t fields 订单表
```

#### 修改表格结构

```bash
# 添加普通字段
t alter add 备注 longText
t alter add 金额 number          # 默认精度2
t alter add 数量 number 0        # 整数
t alter add 金额 number 2        # 2位小数
t alter add 是否启用 checkbox

# 添加关联字段
t alter add 关联客户 link manyOne 客户表

# 添加引用字段（Lookup）
t alter add 客户名称 lookup 关联客户 客户名称

# 添加公式字段
t alter add 总价 formula "{单价} * {数量}"

# 添加公式字段（支持指定表名）
t alter add 订单表 未收金额 formula "{订单金额} - {已收金额}"

# 添加编号格式化公式字段（引用autoNumber字段）
t alter add 订单表 订单号显示 formula "{订单号} + 5000000000"

# 修改number字段的精度
t alter modify 订单金额 precision 0    # 修改为整数
t alter modify 订单金额 precision 2    # 修改为2位小数
t alter modify 订单表 订单金额 precision 0    # 指定表名
```

**字段类型转换说明：**
- `alter add` 命令支持指定表名，格式：`t alter add [表名] <字段名> <字段类型>`
- 如果不指定表名，则使用当前选中的表
- 公式字段表达式中的字段名会自动替换为对应的字段ID
- 支持引用autoNumber字段进行编号格式化

**number字段精度设置：**
- 创建表时：`金额:number:2` 表示2位小数，`数量:number:0` 表示整数
- 添加字段时：`t alter add 金额 number 2` 表示2位小数，`t alter add 数量 number 0` 表示整数
- 修改精度：`t alter modify 订单金额 precision 0` 将精度修改为0（整数）
- 默认精度：如果不指定精度，number字段默认精度为2位小数

### 关联字段支持

CLI 现在支持关联字段的智能处理：

#### 插入关联记录

```bash
# 假设有"订单"表格，其中"客户"是关联字段
t insert 订单号=ORD001 客户=张三 金额=1000

# 支持多种匹配方式：
# 1. 记录ID: 客户=recXXXXXXXXXXXXXXXX
# 2. 显示字段值: 客户=张三  
# 3. 模糊匹配: 客户=张
```

#### 更新关联记录

```bash
# 更新订单的客户关联
t update recXXXXXXXXXXXXXXXX 客户=李四
```

#### 交互式选择

当关联字段有多个匹配结果时，CLI 会显示选择界面：

```
字段 '客户' 找到多个匹配记录:
  1. 张三 (ID: recXXXXXXXXXXXXXX01)
  2. 张三丰 (ID: recXXXXXXXXXXXXXX02)
  3. 张小明 (ID: recXXXXXXXXXXXXXX03)

请选择记录编号 (或输入0取消): 
```

### 高级查询

```bash
# 显示记录（支持分页、过滤、排序）
t show limit=50 order=创建时间:desc

# 过滤查询
t show 状态=已完成 金额>1000

# 模糊查询
t show 客户名称like张

# 组合查询
t show 状态=已完成 金额>1000 order=创建时间:desc limit=20
```

**注意**: 查询结果会自动包含**记录ID**列（第一列，黄色显示），方便您直接复制使用进行后续的更新或删除操作。例如：
```bash
# 查看数据后，直接使用记录ID进行更新
t update recXXXXXXXXXXXXXXXX 状态=已处理

# 或使用记录ID进行删除
t delete recXXXXXXXXXXXXXXXX
```

### 交互式操作

不带参数的插入和更新命令会进入交互式模式：

```bash
# 交互式插入记录
t insert

# 交互式更新记录
t update recXXXXXXXXXXXXXXXX
```

## 关联字段处理机制

### 智能匹配算法

1. **记录ID匹配**: 首先尝试将输入值作为记录ID进行精确匹配
2. **显示字段匹配**: 尝试匹配常见显示字段（name, title 等）
3. **模糊匹配**: 使用 contains 操作符进行模糊查询
4. **交互式选择**: 多个结果时让用户选择

### 支持的关联关系

- manyMany: 多对多
- manyOne: 多对一  
- oneMany: 一对多
- oneOne: 一对一

### 错误处理

- 未找到匹配记录时会显示警告并跳过该字段
- 用户取消选择时会跳过该字段
- 关联字段值为空时会跳过处理

## 示例场景

### 场景1：订单管理

假设有两个表格：
- 客户表：包含客户基本信息
- 订单表：包含订单信息，关联到客户表

```bash
# 1. 切换到订单表
t use 订单

# 2. 插入新订单，关联到客户
t insert 订单号=ORD2024001 客户=张三 产品=笔记本电脑 金额=8999

# 3. 如果"张三"有多个匹配，会显示选择界面
# 4. 更新订单客户
t update recXXXXXXXXXXXXXXXX 客户=李四
```

### 场景2：数据查询

```bash
# 查看最近完成的订单
t use 订单
t show 状态=已完成 order=完成时间:desc limit=10

# 查看特定客户的订单
t show 客户名称=张三 order=创建时间:desc
```

### 管道流式操作

Teable CLI 支持强大的 Linux 管道操作，实现命令链式处理和流式数据更新：

#### 基本管道操作

```bash
# 查询前10条记录
t show | head -10

# 统计记录数量
t show | wc -l

# 查找包含特定文本的记录
t show | grep "客户名称=张三"

# 排序和去重
t show | sort | uniq
```

#### 流式数据插入

管道模式下，`insert` 命令**必须**指定字段映射或常量值，支持两种方式：

**1. 字段映射语法**：`目标字段=@源字段` 或 `目标字段=$源字段`
- 从管道记录中获取指定字段的值
- 如果管道记录中不存在该字段，会跳过该字段

**2. 常量值语法**：`目标字段=常量值`
- 直接使用指定的常量值
- 即使管道记录中有同名字段，也会使用常量值

**使用示例**

```bash
# 使用常量值（直接指定值）
t show | head -1 | t insert 客户名称=新客户 客户编号=999

# 使用字段映射（从管道记录中获取字段值）
t show | head -1 | t insert 新客户名称=@客户名称 新客户编号=@客户编号
# 或者使用 $ 前缀
t show | head -1 | t insert 新客户名称=$客户名称 新客户编号=$客户编号

# 混合使用字段映射和常量值
t show 状态=待处理 | head -3 | t insert 状态=已复制 备注=来自模板 原订单号=@订单号

# 复杂插入逻辑
t show 信用等级=优秀 | head -5 | t insert 标签=优质客户 创建时间=2024-01-01 原客户=$客户名称

# 跨表格复制数据（需要先切换到源表格查询，再切换到目标表格插入）
t use 订单表
t show 创建时间>2024-01-01 > /tmp/orders.txt
t use 订单备份表
cat /tmp/orders.txt | t insert 订单号=@订单号 客户名称=@客户名称 金额=@金额
```

**语法对比**

```bash
# 假设管道记录包含: 订单号=ORD001 客户名称=张三

# 常量值：无论管道记录中有什么，都使用"新客户"
t show | t insert 客户名称=新客户

# 字段映射：从管道记录中获取"客户名称"字段的值（即"张三"）
t show | t insert 客户名称=@客户名称

# 混合使用
t show | t insert 新订单号=ORD999 原客户=@客户名称 状态=已完成
```

**注意事项**

- 管道模式下**必须**提供字段映射参数，否则会提示错误
- 只插入指定的字段，其他字段使用默认值或留空
- 自动跳过系统字段（id, createdTime等）和不可编辑字段（公式字段等）

#### 流式数据更新

**1. 直接更新模式**：更新管道记录本身

```bash
# 批量更新查询结果（使用常量值）
t show 状态=待处理 | t update 状态=处理中

# 使用字段映射更新（从管道记录中获取值）
t show | t update 新状态=@状态 备注=@备注

# 混合使用字段映射和常量值
t show | t update 状态=已完成 处理人=@处理人 完成时间=2024-01-01

# 条件流式更新（只更新前5条）
t show 优先级=高 | head -5 | t update 处理人=张三

# 指定表名更新（更新指定表，而不是当前表）
t show | t update 订单表 状态=已完成
t show | t update 订单表 状态=@状态 备注=@备注
```

**2. Merge Update 模式**：根据 where 条件查找并更新匹配的记录

类似 SQL 的 `UPDATE ... SET ... WHERE ...`，根据管道记录中的值查找目标表格中匹配的记录并更新：

```bash
# 基本用法：根据管道记录中的字段值查找并更新匹配的记录
t show | t update 状态=已完成 where 订单号=@订单号

# 多个条件：使用管道记录中的多个字段值作为查询条件
t show | t update 状态=已完成 备注=@备注 where 订单号=@订单号 客户名称=@客户名称

# 混合条件：部分条件使用管道记录的值，部分使用常量值
t show | t update 状态=已完成 where 订单号=@订单号 状态=待处理

# 复杂条件：支持比较操作符
t show | t update 优先级=高 where 金额>@金额 状态=正常

# 实际应用场景：根据订单号更新订单状态
t show 状态=待处理 | t update 状态=已完成 完成时间=@完成时间 where 订单号=@订单号

# 指定表名进行 merge update（更新指定表，而不是当前表）
t show | t update 订单表 状态=已完成 where 订单号=@订单号
t show | t update 订单表 状态=@状态 where 订单号=@订单号 客户名称=@客户名称
```

**表名参数说明**

- `t update [表名] ...`：指定要更新的表名，如果不指定则更新当前表
- 表名必须是第一个参数（在字段赋值和 where 关键字之前）
- 支持所有更新模式：直接更新、条件更新、管道更新、merge update

**语法说明**

- **更新字段语法**：
  - `目标字段=@源字段`：从管道记录中获取字段值
  - `目标字段=常量值`：使用常量值
- **Where 条件语法**：
  - `字段名=@源字段`：使用管道记录中的字段值作为条件
  - `字段名=常量值`：使用常量值作为条件
  - `字段名>@源字段` 或 `字段名>常量值`：大于条件
  - `字段名<@源字段` 或 `字段名<常量值`：小于条件

**示例对比**

```bash
# 假设管道记录包含: 订单号=ORD001 客户名称=张三 状态=待处理

# 直接更新模式：更新管道记录本身（记录ID为 rec123）
t show | t update 状态=已完成
# 效果：更新记录 rec123 的 状态=已完成

# Merge update模式：查找并更新匹配的记录
t show | t update 状态=已完成 where 订单号=@订单号
# 效果：查找 订单号=ORD001 的所有记录，更新它们的 状态=已完成

# Merge update模式：多个条件
t show | t update 状态=已完成 备注=已处理 where 订单号=@订单号 客户名称=@客户名称
# 效果：查找 订单号=ORD001 AND 客户名称=张三 的所有记录，更新 状态=已完成 和 备注=已处理
```

#### 高级管道工作流

```bash
# 多步骤数据处理流程
t show 创建时间>2024-01-01 | grep "状态=新建" | sort | t update 优先级=最高

# 数据统计和分析
t show | grep "信用等级=优秀" | wc -l                    # 统计优秀客户数量
t show | awk -F'客户名称=' '{print $2}' | awk '{print $1}' | sort | uniq -c  # 客户名称统计

# 分页流式处理
t show | head -20 | t update 标记=前20条记录
t show | tail -10 | t update 标记=最后10条记录
```

#### 流式处理特性

**1. 真正的流式处理**
- 查询一页 → 处理一页 → 下一页，内存占用恒定
- 支持大规模数据集（万级记录）的高效处理
- 早期终止机制（如 `head` 命令）自动停止后续查询

**2. 智能批量更新**
- 自动分批处理（每批10条记录）
- 实时进度显示（每50条显示处理进度）
- 错误处理和重试机制

**3. 零配置设计**
- 自动检测管道输入/输出模式
- 无需额外参数，完全兼容现有命令
- 支持所有标准Unix工具链

#### 流式更新示例

```bash
# 批量更新所有客户状态
t show | t update 状态=已同步

# 按条件分批更新
t show 客户类型=企业客户 | t update 客户等级=VIP
t show 信用等级=优秀 | t update 服务等级=金牌

# 复杂业务逻辑处理
t show 注册时间>2024-01-01 | grep "活跃度=高" | head -100 | t update 标签=重点客户
```

#### 性能特点

- **内存效率**：恒定内存占用，与数据总量无关
- **响应速度**：即时响应，无需等待所有数据加载
- **可扩展性**：支持任意大小的数据集处理
- **可靠性**：100%数据完整性保证

#### 注意事项

1. **管道中断处理**：当管道消费者（如 `head`）关闭时，生产者会自动停止
2. **批次大小**：更新操作默认每批处理10条记录
3. **进度显示**：大量数据更新时会显示实时进度
4. **错误恢复**：单个记录更新失败不会影响整个批次

## 注意事项

1. **关联字段性能**: 大量数据时模糊匹配可能影响性能
2. **字段名称**: 确保使用正确的字段名称，区分大小写
3. **数据类型**: 关联字段最终存储的是记录ID
4. **权限**: 确保有权限访问关联的表格和记录

## 故障排除

### 常见问题

1. **找不到关联记录**
   - 检查外键表中是否存在匹配的数据
   - 尝试使用更精确的匹配条件
   - 确认有权限访问外键表

2. **关联字段更新失败**
   - 确认关联关系类型是否支持更新
   - 检查目标记录是否存在
   - 验证用户权限

3. **性能问题**
   - 尽量使用记录ID进行精确匹配
   - 避免在大量数据上使用模糊匹配

## 更新日志

### v1.3.1
- **新增number字段精度设置功能**
  - 创建表时支持指定精度：`金额:number:2`（2位小数）或 `数量:number:0`（整数）
  - 添加字段时支持指定精度：`t alter add 金额 number 2`
  - 新增修改字段精度命令：`t alter modify <字段名> precision <精度>`
  - 支持指定表名：`t alter modify <表名> <字段名> precision <精度>`
  - 默认精度为2位小数（如果未指定）
  - 使用convert API更新字段精度，确保数据一致性

### v1.3.0
- **新增表格创建功能** (`t create`)
  - 支持创建各种字段类型的表格
  - 支持创建关联字段（link）
  - 支持创建公式字段（formula）
  - 支持创建带选项的字段（singleSelect, multipleSelect）
  - 自动处理字段依赖关系（关联字段和公式字段在表创建后添加）
- **新增表格结构查看功能** (`t desc`, `t schema`, `t fields`)
  - 查看表格的所有字段及其类型
  - 显示关联字段的关联关系
  - 显示公式字段的表达式
- **新增表格结构修改功能** (`t alter add`)
  - 支持添加各种类型的字段
  - 支持添加关联字段和引用字段（lookup）
  - 支持添加公式字段
  - 支持指定表名：`t alter add <表名> <字段名> <字段类型>`
  - 公式字段表达式中的字段名会自动替换为字段ID
- **新增版本命令** (`t version`)
  - 显示 CLI 版本信息
- **改进公式字段支持**
  - 修复了公式字段创建时的字段名解析问题
  - 支持在表达式中引用autoNumber字段进行编号格式化
  - 优化了字段类型转换功能

### v1.2.0
- 新增管道流式操作支持
- 真正的分页流式处理机制
- 智能批量更新（每批10条记录）
- 实时进度显示和错误处理
- 零配置设计，自动检测管道模式
- 支持大规模数据集的高效处理
- **新增 `show | insert` 管道插入功能**
  - 支持字段映射语法（`@字段名` 或 `$字段名`）从管道记录中获取值
  - 支持常量值语法直接指定值
  - 必须明确指定字段映射或常量值，避免歧义

### v1.1.0
- 新增关联字段支持
- 智能记录匹配算法
- 交互式选择界面
- 改进的错误处理

### v1.0.0
- 基础CRUD操作
- 表格管理功能
- 高级查询支持
- 交互式操作界面
